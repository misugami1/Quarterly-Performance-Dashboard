<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AOP Management System ‚Äì BatStateU</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --red: #b71c1c;
      --red-dark: #7f0000;
      --red-light: #ef5350;
      --orange: #e65100;
      --gold: #f9a825;
      --white: #ffffff;
      --off-white: #fafafa;
      --gray-light: #f5f5f5;
      --gray: #9e9e9e;
      --text: #212121;
      --text-muted: #757575;
    }

    html, body { height: 100%; font-family: 'Barlow', sans-serif; }

    /* ===== LOGIN PAGE ===== */
    #page-login {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, var(--red-dark) 0%, var(--red) 40%, var(--orange) 100%);
      position: relative;
      overflow: hidden;
    }
    #page-login::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://source.unsplash.com/1600x900/?university,campus') center/cover no-repeat;
      opacity: 0.15;
    }

    .login-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 32px;
      background: rgba(0,0,0,0.25);
      position: relative;
      z-index: 2;
    }
    .login-header img { width: 52px; height: 52px; border-radius: 50%; }
    .login-header .hd-text h1 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.15rem;
      font-weight: 800;
      color: var(--white);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      line-height: 1.1;
    }
    .login-header .hd-text p {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.75);
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .login-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
      position: relative;
      z-index: 2;
    }

    .login-card {
      background: rgba(255,255,255,0.97);
      border-radius: 12px;
      padding: 40px 44px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.5s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .login-card h2 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--red);
      text-align: center;
      margin-bottom: 28px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px 14px;
      font-family: 'Barlow', sans-serif;
      font-size: 0.95rem;
      color: var(--text);
      transition: border-color 0.2s;
      outline: none;
    }
    .form-group input:focus { border-color: var(--red); }

    .forgot-link {
      text-align: right;
      margin-top: -10px;
      margin-bottom: 14px;
    }
    .forgot-link a { font-size: 0.78rem; color: var(--red); text-decoration: none; }
    .forgot-link a:hover { text-decoration: underline; }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--red), var(--orange));
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:active { transform: scale(0.98); }

    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      color: var(--gray);
      font-size: 0.8rem;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e0e0e0;
    }

    .btn-google {
      width: 100%;
      background: #fff;
      color: var(--text);
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      padding: 11px;
      font-family: 'Barlow', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .btn-google:hover { border-color: var(--red); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-google svg { width: 18px; height: 18px; }

    .no-account {
      text-align: center;
      margin-top: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .no-account a { color: var(--red); text-decoration: none; font-weight: 600; }
    .no-account a:hover { text-decoration: underline; }

    .error-msg {
      background: #ffebee;
      border: 1px solid #ef9a9a;
      color: var(--red);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.82rem;
      margin-bottom: 14px;
      display: none;
    }
    .error-msg.show { display: block; }

    /* ===== PAGES HIDDEN ===== */
    .page { display: none; min-height: 100vh; flex-direction: column; background: var(--gray-light); }
    .page.active { display: flex; }

    /* ===== TOP NAV ===== */
    .topnav {
      background: linear-gradient(90deg, var(--red-dark), var(--red), var(--orange));
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 24px;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }
    .topnav img { width: 40px; height: 40px; border-radius: 50%; }
    .topnav .nav-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      flex: 1;
    }
    .topnav .nav-sub {
      font-size: 0.68rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .btn-home {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: #fff;
      border-radius: 6px;
      padding: 7px 14px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      cursor: pointer;
      text-transform: uppercase;
      transition: background 0.2s;
    }
    .btn-home:hover { background: rgba(255,255,255,0.3); }

    /* ===== HOME PAGE ===== */
    #page-home .home-hero {
      background: linear-gradient(135deg, var(--red-dark), var(--red) 50%, var(--orange));
      padding: 60px 24px;
      text-align: center;
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    #page-home .home-hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://source.unsplash.com/1600x400/?campus') center/cover no-repeat;
      opacity: 0.12;
    }
    #page-home .home-hero h2 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 2.4rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      position: relative;
      z-index: 1;
    }
    #page-home .home-hero p {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 8px;
      position: relative;
      z-index: 1;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .home-steps {
      padding: 32px 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .steps-row {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .step-item {
      flex: 1;
      min-width: 140px;
      background: #fff;
      border-left: 4px solid var(--red);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .step-num {
      background: var(--red);
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    .step-item p {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding-top: 4px;
    }

    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .btn-menu {
      background: linear-gradient(135deg, var(--red), var(--red-dark));
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 18px 24px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      text-align: left;
      transition: transform 0.15s, opacity 0.2s;
      box-shadow: 0 4px 14px rgba(183,28,28,0.3);
    }
    .btn-menu:hover { opacity: 0.9; transform: translateX(4px); }

    /* ===== CONTENT AREA ===== */
    .content { flex: 1; padding: 24px; max-width: 1100px; margin: 0 auto; width: 100%; }

    /* ===== PAGE TITLE ===== */
    .page-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--red);
      padding-bottom: 8px;
    }

    /* ===== FORM CARD ===== */
    .form-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    /* ===== AOP FORM TABLE ===== */
    .aop-table {
      width: 100%;
      border-collapse: collapse;
    }
    .aop-table th {
      background: var(--red);
      color: #fff;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.82rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 10px 12px;
      text-align: left;
    }
    .aop-table td {
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      vertical-align: top;
    }
    .aop-table .section-header td {
      background: #fff3e0;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .aop-table .center-header td {
      background: #fff8f0;
      text-align: center;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--orange);
      letter-spacing: 0.04em;
    }

    .aop-table input[type="text"],
    .aop-table input[type="number"],
    .aop-table textarea,
    .aop-table select {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 7px 9px;
      font-family: 'Barlow', sans-serif;
      font-size: 0.85rem;
      color: var(--text);
      transition: border-color 0.2s;
      outline: none;
      resize: vertical;
    }
    .aop-table input:focus,
    .aop-table textarea:focus,
    .aop-table select:focus { border-color: var(--red); }

    .row-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .row-num-display {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text);
      min-width: 24px;
    }
    .btn-row-ctrl {
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 3px;
      width: 22px;
      height: 22px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-row-ctrl:hover { background: var(--red-dark); }

    .dynamic-row {
      border-top: 2px solid #f5f5f5;
    }
    .dynamic-row td { background: #fafafa; }

    /* Row header inside dynamic rows */
    .row-section-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .file-upload-area {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn-file {
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 14px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
    }
    .btn-file:hover { background: var(--red-dark); }
    .file-name-display {
      font-size: 0.78rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--red-dark), var(--red));
      gap: 12px;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 6px;
      padding: 9px 18px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.35); }
    .btn-save {
      background: var(--gold);
      color: #222;
      border: none;
      border-radius: 6px;
      padding: 9px 22px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.95rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-save:hover { opacity: 0.88; }

    /* ===== RECORDS TABLE ===== */
    .records-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }
    .records-table thead tr {
      background: var(--red);
    }
    .records-table thead th {
      color: #fff;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 10px 10px;
      text-align: left;
      white-space: nowrap;
    }
    .records-table tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.15s;
    }
    .records-table tbody tr:hover { background: #fff3e0; }
    .records-table tbody td { padding: 9px 10px; color: var(--text); vertical-align: middle; }
    .records-table .id-cell {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--red);
      font-size: 0.9rem;
    }

    .action-links { display: flex; gap: 6px; flex-direction: column; }
    .btn-action {
      padding: 4px 10px;
      border-radius: 4px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-view { background: #1565c0; color: #fff; }
    .btn-view:hover { background: #0d47a1; }
    .btn-update { background: var(--orange); color: #fff; }
    .btn-update:hover { background: var(--red); }

    .badge {
      background: var(--gray-light);
      color: var(--text-muted);
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.72rem;
      font-weight: 600;
    }

    /* ===== DASHBOARD ===== */
    .dashboard-header-bar {
      background: linear-gradient(135deg, var(--red-dark), var(--red), var(--orange));
      color: #fff;
      padding: 16px 24px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.1rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .dashboard-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.09);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .dash-card-header {
      background: linear-gradient(90deg, var(--red-dark), var(--red));
      color: #fff;
      padding: 10px 16px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .dash-id-badge {
      background: rgba(255,255,255,0.25);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.78rem;
    }

    .dash-card-body {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 0;
    }

    .dash-left {
      border-right: 1px solid #e0e0e0;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .donut-wrap {
      position: relative;
      width: 120px;
      height: 120px;
      margin-bottom: 10px;
    }
    .donut-wrap canvas { width: 120px !important; height: 120px !important; }
    .donut-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }
    .donut-center .pct {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }
    .donut-center .lbl { font-size: 0.6rem; color: var(--text-muted); }

    .donut-legend {
      display: flex;
      gap: 14px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .donut-legend span { display: flex; align-items: center; gap: 5px; }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .proof-link {
      margin-top: 10px;
      text-align: center;
    }
    .proof-link a {
      font-size: 0.78rem;
      color: var(--red);
      text-decoration: none;
      font-weight: 600;
      border: 1px solid var(--red);
      padding: 3px 10px;
      border-radius: 4px;
    }
    .proof-link a:hover { background: var(--red); color: #fff; }

    .dash-right { padding: 14px 16px; }
    .dash-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .dash-info-item {
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }
    /* Remove the border from the very last item in the grid */
    .dash-info-item:last-child {
      border-bottom: none;
    }
    .dash-info-label {
      font-size: 0.66rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--red);
      margin-bottom: 2px;
    }
    .dash-info-value {
      font-size: 0.82rem;
      color: var(--text);
      font-weight: 500;
    }

    .dash-subtotal {
      border-top: 2px solid #f5f5f5;
      padding: 8px 16px;
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--text);
      background: #fafafa;
    }
    .dash-subtotal span { color: var(--red); }

    .dash-footer {
      padding: 12px 16px;
      background: linear-gradient(90deg, var(--red-dark), var(--red));
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .btn-dash-action {
      color: #fff;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.45);
      border-radius: 5px;
      padding: 6px 16px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-dash-action:hover { background: rgba(255,255,255,0.35); }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      bottom: 28px;
      right: 28px;
      background: #212121;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      z-index: 9999;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success { background: #2e7d32; }
    .toast.error { background: #c62828; }

    /* ===== LOADING ===== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      display: none;
    }
    .loading-overlay.show { display: flex; }
    .spinner {
      width: 44px;
      height: 44px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 680px) {
      .dash-card-body { grid-template-columns: 1fr; }
      .dash-left { border-right: none; border-bottom: 1px solid #e0e0e0; }
      .content { padding: 14px; }
    }
  </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ===== LOGIN PAGE ===== -->
<div id="page-login" class="active" style="display:flex;flex-direction:column;">
  <div class="login-header">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.background='#fff';this.style.padding='4px'"/>
    <div class="hd-text">
      <h1>Batangas State University</h1>
      <p>The National Engineering University ¬∑ Leading Innovations, Transforming Lives</p>
    </div>
  </div>
  <div class="login-body">
    <div class="login-card">
      <h2>AOP Management System</h2>
      <div class="error-msg" id="login-error">Invalid email or password.</div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="you@batstate-u.edu.ph"/>
      </div>
      <div class="form-group">
        <input type="password" id="login-password" placeholder="Password"/>
      </div>
      <div class="forgot-link"><a href="#">Forgot password?</a></div>
      <button class="btn-primary" onclick="doLogin()">Sign In</button>
      <div class="divider">or</div>
      <button class="btn-google" onclick="doLogin()">
        <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.6 33 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.4 6.5 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-9 20-20 0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 15.1 18.9 12 24 12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.4 6.5 29.5 4 24 4 16.3 4 9.7 8.3 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 10-2 13.6-5.2l-6.3-5.2C29.3 35.2 26.8 36 24 36c-5.2 0-9.6-3-11.3-7.5l-6.5 5C9.7 39.6 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.7 2-2.1 3.7-3.8 4.9l6.3 5.2C42.6 34.6 44 29.6 44 24c0-1.3-.1-2.7-.4-4z"/></svg>
        Continue with Google
      </button>
      
      <div class="no-account" style="margin-top: 15px;">
         No account? <a href="#" onclick="showPage('page-register')">Create an account</a>
      </div>
    </div>
  </div>
</div>
<!-- ===== REGISTER PAGE ===== -->
<div id="page-register" class="page">
  <div class="login-header">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png"/>
    <div class="hd-text">
      <h1>Batangas State University</h1>
      <p>AOP Management System</p>
    </div>
  </div>

  <div class="login-body">
    <div class="login-card">
      <h2>Create Account</h2>

      <div class="error-msg" id="register-error"></div>

      <div class="form-group">
        <label>Name</label>
        <input type="text" id="register-name" placeholder="Full Name"/>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="register-email" placeholder="Email"/>
      </div>

      <div class="form-group">
        <label>Password</label>
        <input type="password" id="register-password" placeholder="Password"/>
      </div>

      <button class="btn-primary" onclick="doRegister()">Register</button>

      <div class="no-account">
        Already have an account?
        <a href="#" onclick="showPage('page-login')">Login</a>
      </div>
    </div>
  </div>
</div>

<!-- ===== HOME PAGE ===== -->
<div id="page-home" class="page">
  <nav class="topnav">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.opacity='0'"/>
    <div>
      <div class="nav-title">AOP Management System</div>
      <div class="nav-sub">Batangas State University</div>
    </div>
    <button class="btn-home" onclick="logout()">Logout</button>
  </nav>
  <div style="background:linear-gradient(135deg,#7f0000,#b71c1c 50%,#e65100);padding:52px 24px;text-align:center;color:#fff;position:relative;overflow:hidden;">
    <div style="position:absolute;inset:0;background:url('https://source.unsplash.com/1600x400/?university') center/cover;opacity:0.12;"></div>
    <div style="position:relative;z-index:1;">
      <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:2.2rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;">Welcome to AOP Management System</h2>
      <p style="font-size:0.85rem;opacity:0.75;margin-top:8px;letter-spacing:0.1em;text-transform:uppercase;">Annual Operational Plan ¬∑ FY 2026</p>
    </div>
  </div>
  <div style="display:flex;gap:24px;padding:32px 24px;max-width:900px;margin:0 auto;width:100%;flex-wrap:wrap;">
    <div style="flex:1;min-width:220px;display:flex;flex-direction:column;gap:10px;">
      <div style="background:#fff;border-left:4px solid #b71c1c;border-radius:8px;padding:14px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);">
        <div style="background:#b71c1c;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;flex-shrink:0;">1</div>
        <p style="font-size:0.82rem;font-weight:600;color:#757575;text-transform:uppercase;letter-spacing:0.06em;">Create Plan</p>
      </div>
      <div style="background:#fff;border-left:4px solid #b71c1c;border-radius:8px;padding:14px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);">
        <div style="background:#b71c1c;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;flex-shrink:0;">2</div>
        <p style="font-size:0.82rem;font-weight:600;color:#757575;text-transform:uppercase;letter-spacing:0.06em;">Check Records</p>
      </div>
      <div style="background:#fff;border-left:4px solid #b71c1c;border-radius:8px;padding:14px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);">
        <div style="background:#b71c1c;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;flex-shrink:0;">3</div>
        <p style="font-size:0.82rem;font-weight:600;color:#757575;text-transform:uppercase;letter-spacing:0.06em;">Update Record if Needed</p>
      </div>
      <div style="background:#fff;border-left:4px solid #b71c1c;border-radius:8px;padding:14px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);">
        <div style="background:#b71c1c;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;flex-shrink:0;">4</div>
        <p style="font-size:0.82rem;font-weight:600;color:#757575;text-transform:uppercase;letter-spacing:0.06em;">View Dashboard</p>
      </div>
    </div>
    <div style="flex:1;min-width:220px;display:flex;flex-direction:column;gap:14px;justify-content:center;">
      <button class="btn-menu" onclick="showPage('page-create')">‚ûï &nbsp; Create New Plan</button>
      <button class="btn-menu" onclick="showPage('page-records');loadRecords()">üìã &nbsp; Manage & Update Records</button>
      <button class="btn-menu" onclick="showPage('page-dashboard');loadDashboard()">üìä &nbsp; View Dashboard</button>
    </div>
  </div>
</div>

<!-- ===== CREATE PLAN PAGE ===== -->
<div id="page-create" class="page">
  <nav class="topnav">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.opacity='0'"/>
    <div><div class="nav-title">Create New Operational Plan</div><div class="nav-sub">AOP Management System</div></div>
    <button class="btn-home" onclick="showPage('page-home')">üè† Home</button>
  </nav>
  <div class="content" id="create-content">
    <!-- JS fills this -->
  </div>
</div>

<!-- ===== RECORDS PAGE ===== -->
<div id="page-records" class="page">
  <nav class="topnav">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.opacity='0'"/>
    <div><div class="nav-title">Manage & Update Records</div><div class="nav-sub">AOP Management System</div></div>
    <button class="btn-home" onclick="showPage('page-home')">üè† Home</button>
  </nav>
  <div class="content" id="records-content">
    <!-- JS fills this -->
  </div>
</div>

<!-- ===== UPDATE PAGE ===== -->
<div id="page-update" class="page">
  <nav class="topnav">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.opacity='0'"/>
    <div><div class="nav-title">Manage & Update Records</div><div class="nav-sub">AOP Management System</div></div>
    <button class="btn-home" onclick="showPage('page-records');loadRecords()">‚óÄ Back</button>
  </nav>
  <div class="content" id="update-content">
    <!-- JS fills this -->
  </div>
</div>

<!-- ===== DASHBOARD PAGE ===== -->
<div id="page-dashboard" class="page">
  <nav class="topnav">
    <img src="https://upload.wikimedia.org/wikipedia/en/6/6a/Batangas_State_University_logo.png" alt="BatStateU" onerror="this.style.opacity='0'"/>
    <div><div class="nav-title">AOP Dashboard</div><div class="nav-sub">College of Engineering ‚Äì Alangilan Campus</div></div>
    <button class="btn-home" onclick="showPage('page-home')">üè† Home</button>
  </nav>
  <div class="dashboard-header-bar">AOP Dashboard ‚Äì College of Engineering (Alangilan Campus)</div>
  <div class="content" id="dashboard-content">
    <!-- JS fills this -->
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
const API = ''; // relative, same origin

/* ===== UTILITIES ===== */
function showPage(id) {
  document.querySelectorAll('.page, #page-login').forEach(p => {
    p.style.display = 'none';
    p.classList.remove('active');
  });
  const el = document.getElementById(id);
  el.style.display = 'flex';
  el.classList.add('active');
  window.scrollTo(0,0);
}

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 3000);
}

function showLoading(v) {
  document.getElementById('loading').style.display = v ? 'flex' : 'none';
}

function formatDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-PH', {month:'2-digit',day:'2-digit',year:'2-digit'});
}

async function apiFetch(url, opts={}) {
  showLoading(true);
  try {
    const res = await fetch(API + url, {
      headers: {'Content-Type': 'application/json', ...opts.headers},
      ...opts
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Server error');
    return data;
  } finally {
    showLoading(false);
  }
}

/* ===== AUTH ===== */
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value.trim();
  const errEl = document.getElementById('login-error');
  errEl.classList.remove('show');
  if (!email || !pass) { errEl.classList.add('show'); errEl.textContent='Please fill in all fields.'; return; }
  try {
    const res = await fetch('/api/auth/login', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, password:pass})
    });
    const data = await res.json();
    if (!res.ok) { errEl.classList.add('show'); errEl.textContent = data.message || 'Invalid credentials.'; return; }
    localStorage.setItem('aop_token', data.token || 'demo');
    showPage('page-home');
    initCreateForm();
  } catch(e) {
    // Demo mode ‚Äì proceed anyway
    localStorage.setItem('aop_token', 'demo');
    showPage('page-home');
    initCreateForm();
  }
}
async function doRegister() {
  const name  = document.getElementById('register-name').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const pass  = document.getElementById('register-password').value.trim();
  const errEl = document.getElementById('register-error');

  errEl.classList.remove('show');

  if (!name || !email || !pass) {
    errEl.classList.add('show');
    errEl.textContent = 'Please fill in all fields.';
    return;
  }

  try {
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password: pass })
    });

    const data = await res.json();

    if (!res.ok) {
      errEl.classList.add('show');
      errEl.textContent = data.message || 'Registration failed.';
      return;
    }

    showToast('Account created successfully!');
    showPage('page-login');

  } catch (err) {
    errEl.classList.add('show');
    errEl.textContent = 'Server error.';
  }
}
function logout() {
  localStorage.removeItem('aop_token');
  document.getElementById('page-login').style.display = 'flex';
  showPage('page-login');
}

/* ===== CREATE FORM ===== */
let rowCount = 1;
let currentPlanId = null; // for edit mode

function initCreateForm(planData=null, editMode=false) {
  rowCount = planData ? planData.rows.length : 1;
  currentPlanId = planData ? planData._id : null;
  const container = document.getElementById('create-content');
  const title = editMode ? 'Manage & Update Records' : 'Create New Operational Plan';
  const btnLabel = editMode ? 'Update Record' : 'Save Record';
  const saveFn = editMode ? 'updatePlan()' : 'savePlan()';

  let rowsHtml = '';
  const rows = planData ? planData.rows : [newRowData()];
  rows.forEach((r, i) => { rowsHtml += buildRowHtml(i+1, rows.length, r); });

  container.innerHTML = `
  <div class="page-title">${title}</div>
  <div class="form-card">
    <table class="aop-table" id="aop-form-table">
      <thead>
        <tr>
          <th>Development Area</th>
          <th>Outcome</th>
          <th colspan="2">Strategy</th>
          <th>ID No.</th>
        </tr>
      </thead>
      <tbody id="plan-header-body">
        <tr>
          <td><input type="text" id="f-devarea" value="${esc(planData?.developmentArea||'')}" placeholder="Development Area"/></td>
          <td><input type="text" id="f-outcome" value="${esc(planData?.outcome||'')}" placeholder="Outcome"/></td>
          <td colspan="2"><input type="text" id="f-strategy" value="${esc(planData?.strategy||'')}" placeholder="Strategy"/></td>
          <td style="text-align:center;font-weight:700;color:var(--red);" id="id-display">${planData ? planData.idNo : 'Auto'}</td>
        </tr>
      </tbody>
    </table>

    <div id="rows-container">
      ${rowsHtml}
    </div>

    <div style="padding:10px 14px;background:#fff8f0;">
      <button class="btn-file" onclick="addRow()">+ Add Row</button>
      <span style="font-size:0.75rem;color:var(--text-muted);margin-left:10px;">Each row = separate PAP entry</span>
    </div>

    <div class="form-footer">
      <button class="btn-secondary" onclick="showPage('page-home')">üè† Back Home</button>
      <button class="btn-save" onclick="${saveFn}">${btnLabel}</button>
    </div>
  </div>`;
}

function newRowData() {
  return {pap:'', perfIndicator:'', targetQ1:'', targetQ2:'', targetQ3:'', targetQ4:'',
          actualQ1:'', actualQ2:'', actualQ3:'', actualQ4:'',
          office:'', totalEstCost:'', fundSource:'', risk:'',
          mitigatingActivities:'', proofFile:'', rowNo:1};
}

function buildRowHtml(rowNo, total, r={}) {
  return `
  <div class="dynamic-row" id="row-block-${rowNo}" data-rowno="${rowNo}">
    <table class="aop-table" style="border-top:2px solid #e0e0e0;">
      <tbody>
        <tr class="section-header">
          <td colspan="2"><span class="row-section-label">Programs, Activities and Project (PAPs)</span></td>
          <td colspan="2"><span class="row-section-label">Performance Indicator</span></td>
          <td>
            <div class="row-controls">
              <span class="row-num-display">${rowNo}</span>
              <button class="btn-row-ctrl" onclick="moveRow(${rowNo},-1)" title="Move Up">‚ñ≤</button>
              <button class="btn-row-ctrl" onclick="moveRow(${rowNo},1)" title="Move Down">‚ñº</button>
              ${total > 1 ? `<button class="btn-row-ctrl" style="background:#e53935;" onclick="removeRow(${rowNo})" title="Remove">‚úï</button>` : ''}
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="2"><textarea id="r${rowNo}-pap" rows="2" placeholder="Programs, Activities and Project">${esc(r.pap||'')}</textarea></td>
          <td colspan="2"><textarea id="r${rowNo}-perfindicator" rows="2" placeholder="Performance Indicator">${esc(r.perfIndicator||'')}</textarea></td>
          <td></td>
        </tr>
        <tr class="center-header">
          <td colspan="5" style="text-align:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:0.9rem;color:var(--orange);background:#fff8f0;">
            Quarterly Targets vs Actuals
          </td>
        </tr>
        <tr class="section-header">
          <td><span class="row-section-label">Target Q1</span></td>
          <td><span class="row-section-label">Target Q2</span></td>
          <td><span class="row-section-label">Target Q3</span></td>
          <td colspan="2"><span class="row-section-label">Target Q4</span></td>
        </tr>
        <tr>
          <td><input type="number" id="r${rowNo}-tq1" value="${r.targetQ1||''}" placeholder="0"/></td>
          <td><input type="number" id="r${rowNo}-tq2" value="${r.targetQ2||''}" placeholder="0"/></td>
          <td><input type="number" id="r${rowNo}-tq3" value="${r.targetQ3||''}" placeholder="0"/></td>
          <td colspan="2"><input type="number" id="r${rowNo}-tq4" value="${r.targetQ4||''}" placeholder="0"/></td>
        </tr>
        <tr class="section-header">
          <td><span class="row-section-label">Actual Q1</span></td>
          <td><span class="row-section-label">Actual Q2</span></td>
          <td><span class="row-section-label">Actual Q3</span></td>
          <td colspan="2"><span class="row-section-label">Actual Q4</span></td>
        </tr>
        <tr>
          <td><input type="number" id="r${rowNo}-aq1" value="${r.actualQ1||''}" placeholder="0"/></td>
          <td><input type="number" id="r${rowNo}-aq2" value="${r.actualQ2||''}" placeholder="0"/></td>
          <td><input type="number" id="r${rowNo}-aq3" value="${r.actualQ3||''}" placeholder="0"/></td>
          <td colspan="2"><input type="number" id="r${rowNo}-aq4" value="${r.actualQ4||''}" placeholder="0"/></td>
        </tr>
        <tr class="section-header">
          <td><span class="row-section-label">Office</span></td>
          <td><span class="row-section-label">Total Est. Cost</span></td>
          <td><span class="row-section-label">Fund Source</span></td>
          <td colspan="2"><span class="row-section-label">Risk Assessment</span></td>
        </tr>
        <tr>
          <td><input type="text" id="r${rowNo}-office" value="${esc(r.office||'')}" placeholder="Office"/></td>
          <td><input type="number" id="r${rowNo}-estcost" value="${r.totalEstCost||''}" placeholder="0.00"/></td>
          <td><input type="text" id="r${rowNo}-fundsource" value="${esc(r.fundSource||'')}" placeholder="Fund Source"/></td>
          <td colspan="2"><input type="text" id="r${rowNo}-risk" value="${esc(r.risk||'')}" placeholder="Risk Assessment"/></td>
        </tr>
        <tr class="section-header">
          <td colspan="2"><span class="row-section-label">Mitigating Activities</span></td>
          <td colspan="3"><span class="row-section-label">Upload Proof / Evidence</span></td>
        </tr>
        <tr>
          <td colspan="2"><textarea id="r${rowNo}-mitigating" rows="2" placeholder="Mitigating Activities">${esc(r.mitigatingActivities||'')}</textarea></td>
          <td colspan="3">
            <div class="file-upload-area">
              <input type="file" id="r${rowNo}-file" style="display:none;" onchange="fileSelected(${rowNo},this)" accept="image/*,application/pdf"/>
              <button class="btn-file" onclick="document.getElementById('r${rowNo}-file').click()">Choose File</button>
              <span class="file-name-display" id="r${rowNo}-fname">${r.proofFile ? r.proofFile : 'No File Chosen'}</span>
              ${r.proofFile ? `<a href="/uploads/${r.proofFile}" target="_blank" style="font-size:0.75rem;color:var(--red);font-weight:600;">[ View ]</a>` : ''}
            </div>
            <input type="hidden" id="r${rowNo}-existingfile" value="${esc(r.proofFile||'')}"/>
          </td>
        </tr>
      </tbody>
    </table>
  </div>`;
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function fileSelected(rowNo, input) {
  const name = input.files[0] ? input.files[0].name : 'No File Chosen';
  document.getElementById('r' + rowNo + '-fname').textContent = name;
}

function addRow() {
  rowCount++;
  const cont = document.getElementById('rows-container');
  const div = document.createElement('div');
  div.innerHTML = buildRowHtml(rowCount, rowCount, newRowData());
  cont.appendChild(div.firstElementChild);
}

function removeRow(rowNo) {
  const el = document.getElementById('row-block-' + rowNo);
  if (el) el.remove();
}

function moveRow(rowNo, dir) { /* simplified: just scrolls */ }

function collectFormData() {
  const devArea = document.getElementById('f-devarea')?.value.trim();
  const outcome = document.getElementById('f-outcome')?.value.trim();
  const strategy = document.getElementById('f-strategy')?.value.trim();
  if (!devArea || !outcome || !strategy) { showToast('Please fill in Development Area, Outcome and Strategy.','error'); return null; }

  const rows = [];
  document.querySelectorAll('#rows-container .dynamic-row').forEach(block => {
    const n = block.dataset.rowno;
    rows.push({
      rowNo: parseInt(n),
      pap: document.getElementById('r'+n+'-pap')?.value.trim()||'',
      perfIndicator: document.getElementById('r'+n+'-perfindicator')?.value.trim()||'',
      targetQ1: parseFloat(document.getElementById('r'+n+'-tq1')?.value)||0,
      targetQ2: parseFloat(document.getElementById('r'+n+'-tq2')?.value)||0,
      targetQ3: parseFloat(document.getElementById('r'+n+'-tq3')?.value)||0,
      targetQ4: parseFloat(document.getElementById('r'+n+'-tq4')?.value)||0,
      actualQ1: parseFloat(document.getElementById('r'+n+'-aq1')?.value)||0,
      actualQ2: parseFloat(document.getElementById('r'+n+'-aq2')?.value)||0,
      actualQ3: parseFloat(document.getElementById('r'+n+'-aq3')?.value)||0,
      actualQ4: parseFloat(document.getElementById('r'+n+'-aq4')?.value)||0,
      office: document.getElementById('r'+n+'-office')?.value.trim()||'',
      totalEstCost: parseFloat(document.getElementById('r'+n+'-estcost')?.value)||0,
      fundSource: document.getElementById('r'+n+'-fundsource')?.value.trim()||'',
      risk: document.getElementById('r'+n+'-risk')?.value.trim()||'',
      mitigatingActivities: document.getElementById('r'+n+'-mitigating')?.value.trim()||'',
      existingProof: document.getElementById('r'+n+'-existingfile')?.value||'',
      _fileInput: document.getElementById('r'+n+'-file')
    });
  });
  return { developmentArea: devArea, outcome, strategy, rows };
}

async function savePlan() {
  const data = collectFormData();
  if (!data) return;
  try {
    const formData = new FormData();
    formData.append('developmentArea', data.developmentArea);
    formData.append('outcome', data.outcome);
    formData.append('strategy', data.strategy);
    const rowsPayload = data.rows.map(r => ({ ...r, _fileInput: undefined }));
    formData.append('rows', JSON.stringify(rowsPayload));
    data.rows.forEach((r, i) => {
      if (r._fileInput && r._fileInput.files[0]) {
        formData.append(`file_row_${r.rowNo}`, r._fileInput.files[0]);
      }
    });
    showLoading(true);
    const res = await fetch('/api/plans', { method:'POST', body: formData });
    const result = await res.json();
    showLoading(false);
    if (!res.ok) throw new Error(result.message);
    showToast('Plan saved successfully!', 'success');
    initCreateForm();
  } catch(e) {
    showLoading(false);
    showToast('Error saving: ' + e.message, 'error');
  }
}

async function updatePlan() {
  const data = collectFormData();
  if (!data) return;
  try {
    const formData = new FormData();
    formData.append('developmentArea', data.developmentArea);
    formData.append('outcome', data.outcome);
    formData.append('strategy', data.strategy);
    const rowsPayload = data.rows.map(r => ({ ...r, _fileInput: undefined }));
    formData.append('rows', JSON.stringify(rowsPayload));
    data.rows.forEach((r) => {
      if (r._fileInput && r._fileInput.files[0]) {
        formData.append(`file_row_${r.rowNo}`, r._fileInput.files[0]);
      }
    });
    showLoading(true);
    const res = await fetch('/api/plans/' + currentPlanId, { method:'PUT', body: formData });
    const result = await res.json();
    showLoading(false);
    if (!res.ok) throw new Error(result.message);
    showToast('Record updated!', 'success');
    showPage('page-records');
    loadRecords();
  } catch(e) {
    showLoading(false);
    showToast('Error updating: ' + e.message, 'error');
  }
}

/* ===== RECORDS ===== */
async function loadRecords() {
  const cont = document.getElementById('records-content');
  cont.innerHTML = '<div class="page-title">Manage & Update Records</div><div style="padding:20px;color:#888;">Loading‚Ä¶</div>';
  try {
    const plans = await apiFetch('/api/plans');
    if (!plans.length) {
      cont.innerHTML = `<div class="page-title">Manage & Update Records</div>
        <div style="background:#fff;border-radius:8px;padding:40px;text-align:center;color:var(--text-muted);">
          No records found. <a href="#" onclick="showPage('page-create');initCreateForm()" style="color:var(--red);font-weight:600;">Create your first plan.</a>
        </div>`;
      return;
    }
    let rows = '';
    [...plans].reverse().forEach(p => {
      const totalQ = p.rows.reduce((s,r) => s + (r.targetQ1+r.targetQ2+r.targetQ3+r.targetQ4), 0);
      rows += `<tr>
        <td class="id-cell">${p.idNo}</td>
        <td><span class="badge">${p.rows.length}</span></td>
        <td>${p.developmentArea}</td>
        <td>${p.outcome}</td>
        <td>${p.strategy}</td>
        <td>${p.rows[0]?.pap || '‚Äî'}</td>
        <td style="text-align:center;font-weight:700;">${totalQ}</td>
        <td>
          <div class="action-links">
            <button class="btn-action btn-view" onclick="showDashboardSingle('${p._id}')">[ VIEW ]</button>
            <button class="btn-action btn-update" onclick="openUpdate('${p._id}')">[ UPDATE ]</button>
          </div>
        </td>
        <td>${formatDate(p.createdAt)}</td>
        <td>${formatDate(p.updatedAt)}</td>
      </tr>`;
    });
    cont.innerHTML = `<div class="page-title">Manage & Update Records</div>
      <div class="form-card" style="overflow:auto;">
        <table class="records-table">
          <thead><tr>
            <th>ID No.</th><th>Total Row</th><th>Development Area</th>
            <th>Outcome</th><th>Strategy</th><th>PAPs</th>
            <th>Total Q</th><th>View/Update</th><th>Created</th><th>Updated</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  } catch(e) {
    cont.innerHTML = `<div class="page-title">Manage & Update Records</div>
      <div style="color:var(--red);padding:20px;">Error loading records: ${e.message}</div>`;
  }
}

async function openUpdate(id) {
  try {
    const plan = await apiFetch('/api/plans/' + id);
    showPage('page-update');
    const cont = document.getElementById('update-content');
    cont.innerHTML = '';
    // reuse create form logic but in update container
    document.getElementById('create-content').innerHTML = '';
    rowCount = plan.rows.length;
    currentPlanId = plan._id;
    let rowsHtml = '';
    plan.rows.forEach((r,i) => { rowsHtml += buildRowHtml(i+1, plan.rows.length, r); });
    cont.innerHTML = `
    <div class="page-title">Manage & Update Records</div>
    <div class="form-card">
      <table class="aop-table">
        <thead><tr>
          <th>Development Area</th><th>Outcome</th><th colspan="2">Strategy</th><th>ID No.</th>
        </tr></thead>
        <tbody>
          <tr>
            <td><input type="text" id="f-devarea" value="${esc(plan.developmentArea)}" placeholder="Development Area"/></td>
            <td><input type="text" id="f-outcome" value="${esc(plan.outcome)}" placeholder="Outcome"/></td>
            <td colspan="2"><input type="text" id="f-strategy" value="${esc(plan.strategy)}" placeholder="Strategy"/></td>
            <td style="text-align:center;font-weight:700;color:var(--red);">${plan.idNo}</td>
          </tr>
        </tbody>
      </table>
      <div id="rows-container">${rowsHtml}</div>
      <div style="padding:10px 14px;background:#fff8f0;">
        <button class="btn-file" onclick="addRowInUpdate()">+ Add Row</button>
      </div>
      <div class="form-footer">
        <button class="btn-secondary" onclick="showPage('page-records');loadRecords()">üè† Back Home</button>
        <button class="btn-save" onclick="doUpdate('${plan._id}')">Update Record</button>
      </div>
    </div>`;
  } catch(e) {
    showToast('Error loading plan: ' + e.message,'error');
  }
}

function addRowInUpdate() {
  rowCount++;
  const cont = document.getElementById('rows-container');
  const div = document.createElement('div');
  div.innerHTML = buildRowHtml(rowCount, rowCount, newRowData());
  cont.appendChild(div.firstElementChild);
}

async function doUpdate(id) {
  const data = collectFormData();
  if (!data) return;
  try {
    const formData = new FormData();
    formData.append('developmentArea', data.developmentArea);
    formData.append('outcome', data.outcome);
    formData.append('strategy', data.strategy);
    const rowsPayload = data.rows.map(r => ({ ...r, _fileInput: undefined }));
    formData.append('rows', JSON.stringify(rowsPayload));
    data.rows.forEach(r => {
      if (r._fileInput && r._fileInput.files[0]) formData.append(`file_row_${r.rowNo}`, r._fileInput.files[0]);
    });
    showLoading(true);
    const res = await fetch('/api/plans/' + id, { method:'PUT', body: formData });
    const result = await res.json();
    showLoading(false);
    if (!res.ok) throw new Error(result.message);
    showToast('Record updated!', 'success');
    showPage('page-records');
    loadRecords();
  } catch(e) {
    showLoading(false);
    showToast('Error: ' + e.message,'error');
  }
}

/* ===== DASHBOARD ===== */
async function loadDashboard() {
  const cont = document.getElementById('dashboard-content');
  cont.innerHTML = '<div style="padding:30px;color:#888;">Loading dashboard‚Ä¶</div>';
  try {
    const plans = await apiFetch('/api/plans');
    if (!plans.length) {
      cont.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);">No plans yet.</div>';
      return;
    }
    let html = '';
    plans.forEach(plan => {
      plan.rows.forEach((row, ri) => {
        const totalTarget = (row.targetQ1||0)+(row.targetQ2||0)+(row.targetQ3||0)+(row.targetQ4||0);
        const totalActual = (row.actualQ1||0)+(row.actualQ2||0)+(row.actualQ3||0)+(row.actualQ4||0);
        const tPct = totalTarget > 0 ? Math.round((totalActual/totalTarget)*100) : 0;
        const aPct = 100 - tPct;
        const canvasId = `donut-${plan._id}-${ri}`;
        const subtotal = plan.rows.reduce((s,r)=>s+(r.totalEstCost||0),0);
        html += `
        <div class="dashboard-card">
          <div class="dash-card-header">
            <span>FY 2026 Annual Operational Plan ¬∑ College of Engineering Alangilan Campus</span>
            <span class="dash-id-badge">ID NO. ${plan.idNo}</span>
            <span class="dash-id-badge">ROW NO. ${ri+1}</span>
          </div>
          <table class="aop-table" style="border-bottom:1px solid #eee;">
            <thead><tr>
              <th>Development Area</th><th>Outcome</th><th>Strategy</th><th>PAPs</th><th>Performance Indicator</th>
            </tr></thead>
            <tbody><tr>
              <td>${esc(plan.developmentArea)}</td>
              <td>${esc(plan.outcome)}</td>
              <td>${esc(plan.strategy)}</td>
              <td>${esc(row.pap)}</td>
              <td>${esc(row.perfIndicator)}</td>
            </tr></tbody>
          </table>
          <div class="dash-card-body">
            <div class="dash-left">
              <div style="font-size:0.72rem;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Actual vs Target</div>
              <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:6px;">Total Quarter (Q1+Q2+Q3+Q4)</div>
              <div class="donut-wrap">
                <canvas id="${canvasId}"></canvas>
                <div class="donut-center">
                  <div class="pct">${tPct}%</div>
                  <div class="lbl">Actual</div>
                </div>
              </div>
              <div class="donut-legend">
                <span><span class="legend-dot" style="background:#f9a825;"></span>Actual ${tPct}%</span>
                <span><span class="legend-dot" style="background:#212121;"></span>Target ${aPct}%</span>
              </div>
              ${row.proofFile ? `<div class="proof-link"><br/><strong style="font-size:0.72rem;color:var(--text-muted);">PROOF/EVIDENCE</strong><br/><a href="/uploads/${row.proofFile}" target="_blank">[ VIEW ]</a></div>` : `<div style="margin-top:10px;font-size:0.72rem;color:var(--text-muted);">No proof uploaded</div>`}
            </div>
            <div class="dash-right">
              <div class="dash-info-grid">
                <div class="dash-info-item">
                  <div class="dash-info-label">Office</div>
                  <div class="dash-info-value">${esc(row.office)||'‚Äî'}</div>
                </div>
                <div class="dash-info-item">
                  <div class="dash-info-label">Total Est. Cost</div>
                  <div class="dash-info-value">‚Ç±${(row.totalEstCost||0).toLocaleString()}</div>
                </div>
                <div class="dash-info-item">
                  <div class="dash-info-label">Fund Source</div>
                  <div class="dash-info-value">${esc(row.fundSource)||'‚Äî'}</div>
                </div>
                <div class="dash-info-item">
                  <div class="dash-info-label">Risk</div>
                  <div class="dash-info-value">${esc(row.risk)||'‚Äî'}</div>
                </div>
                <div class="dash-info-item" style="grid-column:1/-1;">
                  <div class="dash-info-label">Mitigating Activities</div>
                  <div class="dash-info-value">${esc(row.mitigatingActivities)||'‚Äî'}</div>
                </div>
                <div class="dash-info-item">
                  <div class="dash-info-label">Risk Assessment</div>
                  <div class="dash-info-value">${esc(row.risk)||'‚Äî'}</div>
                </div>
              </div>
              ${ri === plan.rows.length-1 ? `<div class="dash-subtotal">SUBTOTAL: <span>‚Ç±${subtotal.toLocaleString()}</span> (Sum Est. Cost)</div>` : ''}
            </div>
          </div>
          <div class="dash-footer">
            <button class="btn-dash-action" onclick="showDashboardAll()">View All</button>
            <button class="btn-dash-action" onclick="window.print()">Print</button>
            <button class="btn-dash-action" onclick="openUpdate('${plan._id}')">Manage/Update</button>
          </div>
        </div>`;
      });
    });
    cont.innerHTML = html;
    // draw donuts
    plans.forEach(plan => {
      plan.rows.forEach((row, ri) => {
        const totalTarget = (row.targetQ1||0)+(row.targetQ2||0)+(row.targetQ3||0)+(row.targetQ4||0);
        const totalActual = (row.actualQ1||0)+(row.actualQ2||0)+(row.actualQ3||0)+(row.actualQ4||0);
        const tPct = totalTarget > 0 ? Math.round((totalActual/totalTarget)*100) : 0;
        drawDonut(`donut-${plan._id}-${ri}`, tPct, 100-tPct);
      });
    });
  } catch(e) {
    cont.innerHTML = `<div style="color:var(--red);padding:20px;">Error: ${e.message}</div>`;
  }
}

function drawDonut(id, actual, target) {
  const canvas = document.getElementById(id);
  if (!canvas) return;
  new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels: ['Actual','Target'],
      datasets:[{ data:[actual, Math.max(target,0)], backgroundColor:['#f9a825','#212121'], borderWidth:0 }]
    },
    options: {
      cutout: '65%',
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      animation: { duration: 700 }
    }
  });
}

async function showDashboardSingle(id) {
  showPage('page-dashboard');
  await loadDashboard();
}

function showDashboardAll() {
  showPage('page-dashboard');
  loadDashboard();
}

/* ===== INIT ===== */
window.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('aop_token');
  if (token) {
    showPage('page-home');
    initCreateForm();
  } else {
    document.getElementById('page-login').style.display = 'flex';
  }
  // allow Enter key on login
  document.getElementById('login-password')?.addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
});
</script>
</body>
</html>
